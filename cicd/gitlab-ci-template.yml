# US#53 - GitLab CI Template para Risk Gate
# 
# Este template valida Merge Requests usando o backoffice-alerta como gate de risco.
#
# Comportamento:
# - exitCode 0 (APROVADO) â†’ Pipeline continua
# - exitCode 1 (APROVADO_COM_RESTRICOES) â†’ Warning, pipeline continua
# - exitCode 2 (BLOQUEADO) â†’ Pipeline falha
#
# ConfiguraÃ§Ã£o necessÃ¡ria:
# 1. CI/CD Variables no GitLab:
#    - BACKOFFICE_ALERTA_URL: URL da API (ex: https://alerta.company.com)
#    - BACKOFFICE_ALERTA_TOKEN: JWT token para autenticaÃ§Ã£o (masked)
#    - GITLAB_TOKEN: Personal Access Token do GitLab (masked)
#
# 2. VariÃ¡veis de ambiente no backoffice-alerta:
#    - GITLAB_TOKEN: Personal Access Token do GitLab (para leitura de MRs)
#
# Como usar:
# 1. Adicione este arquivo ao seu repositÃ³rio como .gitlab-ci.yml
# 2. Ou inclua no seu .gitlab-ci.yml existente:
#    include:
#      - local: '/cicd/gitlab-ci-template.yml'

stages:
  - risk-gate

variables:
  # ConfiguraÃ§Ãµes padrÃ£o (podem ser sobrescritas)
  RISK_GATE_FAIL_ON_BLOCK: "true"
  RISK_GATE_WARN_ON_RESTRICTIONS: "true"

.risk-gate-base:
  stage: risk-gate
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  only:
    - merge_requests
  artifacts:
    reports:
      dotenv: risk-gate.env
    paths:
      - risk-gate-response.json
    expire_in: 30 days

risk-gate:production:
  extends: .risk-gate-base
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
  variables:
    RISK_ENVIRONMENT: "PRODUCTION"
  script:
    - |
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ” RISK GATE ANALYSIS (PRODUCTION)"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "Repository: $CI_PROJECT_PATH"
      echo "MR Number: $CI_MERGE_REQUEST_IID"
      echo "Target Branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
      echo ""
      
      # Determina tipo de mudanÃ§a baseado no tÃ­tulo do MR
      MR_TITLE="$CI_MERGE_REQUEST_TITLE"
      if [[ "$MR_TITLE" == hotfix:* || "$MR_TITLE" == fix:* ]]; then
        CHANGE_TYPE="HOTFIX"
      elif [[ "$MR_TITLE" == feat:* || "$MR_TITLE" == feature:* ]]; then
        CHANGE_TYPE="FEATURE"
      elif [[ "$MR_TITLE" == refactor:* ]]; then
        CHANGE_TYPE="REFACTOR"
      else
        CHANGE_TYPE="FEATURE"
      fi
      
      echo "Change Type: $CHANGE_TYPE"
      echo ""
      
      # Chama API do backoffice-alerta
      HTTP_CODE=$(curl -s -w "%{http_code}" -o risk-gate-response.json \
        -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $BACKOFFICE_ALERTA_TOKEN" \
        -d "{
          \"provider\": \"GITLAB\",
          \"repositoryUrl\": \"$CI_PROJECT_URL\",
          \"pullRequestNumber\": \"$CI_MERGE_REQUEST_IID\",
          \"environment\": \"$RISK_ENVIRONMENT\",
          \"changeType\": \"$CHANGE_TYPE\"
        }" \
        "$BACKOFFICE_ALERTA_URL/risk/ci/gate")
      
      # Verifica se request foi bem sucedida
      if [[ "$HTTP_CODE" != "200" ]]; then
        echo "âŒ Erro ao chamar API: HTTP $HTTP_CODE"
        cat risk-gate-response.json || echo "No response body"
        exit 1
      fi
      
      # Extrai dados da resposta
      EXIT_CODE=$(jq -r '.exitCode' risk-gate-response.json)
      DECISION=$(jq -r '.finalDecision' risk-gate-response.json)
      RISK=$(jq -r '.overallRiskLevel' risk-gate-response.json)
      SUMMARY=$(jq -r '.summary' risk-gate-response.json)
      
      echo "Decision: $DECISION"
      echo "Risk Level: $RISK"
      echo "Exit Code: $EXIT_CODE"
      echo ""
      echo "Summary:"
      echo "$SUMMARY"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # Mostra aÃ§Ãµes requeridas
      ACTIONS=$(jq -r '.actionsRequired[]?' risk-gate-response.json 2>/dev/null || true)
      if [[ -n "$ACTIONS" ]]; then
        echo ""
        echo "âš ï¸ Actions Required:"
        echo "$ACTIONS" | while read line; do
          echo "  - $line"
        done
        echo ""
      fi
      
      # Salva variÃ¡veis para prÃ³ximos jobs
      echo "RISK_EXIT_CODE=$EXIT_CODE" >> risk-gate.env
      echo "RISK_DECISION=$DECISION" >> risk-gate.env
      echo "RISK_LEVEL=$RISK" >> risk-gate.env
      
      # Processa decisÃ£o
      if [[ "$EXIT_CODE" == "2" ]]; then
        echo "âŒ Pipeline BLOQUEADO por polÃ­tica de risco"
        if [[ "$RISK_GATE_FAIL_ON_BLOCK" == "true" ]]; then
          exit 1
        else
          echo "âš ï¸ RISK_GATE_FAIL_ON_BLOCK=false, continuando com warning"
        fi
      elif [[ "$EXIT_CODE" == "1" ]]; then
        echo "âš ï¸ Pipeline aprovado COM RESTRIÃ‡Ã•ES"
      else
        echo "âœ… Pipeline APROVADO"
      fi

risk-gate:staging:
  extends: .risk-gate-base
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "staging"'
  variables:
    RISK_ENVIRONMENT: "STAGING"
  script:
    - |
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ” RISK GATE ANALYSIS (STAGING)"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "Repository: $CI_PROJECT_PATH"
      echo "MR Number: $CI_MERGE_REQUEST_IID"
      echo "Target Branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
      echo ""
      
      # Determina tipo de mudanÃ§a
      MR_TITLE="$CI_MERGE_REQUEST_TITLE"
      if [[ "$MR_TITLE" == hotfix:* || "$MR_TITLE" == fix:* ]]; then
        CHANGE_TYPE="HOTFIX"
      elif [[ "$MR_TITLE" == feat:* || "$MR_TITLE" == feature:* ]]; then
        CHANGE_TYPE="FEATURE"
      elif [[ "$MR_TITLE" == refactor:* ]]; then
        CHANGE_TYPE="REFACTOR"
      else
        CHANGE_TYPE="FEATURE"
      fi
      
      echo "Change Type: $CHANGE_TYPE"
      echo ""
      
      # Chama API
      HTTP_CODE=$(curl -s -w "%{http_code}" -o risk-gate-response.json \
        -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $BACKOFFICE_ALERTA_TOKEN" \
        -d "{
          \"provider\": \"GITLAB\",
          \"repositoryUrl\": \"$CI_PROJECT_URL\",
          \"pullRequestNumber\": \"$CI_MERGE_REQUEST_IID\",
          \"environment\": \"$RISK_ENVIRONMENT\",
          \"changeType\": \"$CHANGE_TYPE\"
        }" \
        "$BACKOFFICE_ALERTA_URL/risk/ci/gate")
      
      if [[ "$HTTP_CODE" != "200" ]]; then
        echo "âŒ Erro ao chamar API: HTTP $HTTP_CODE"
        exit 1
      fi
      
      # Extrai e processa resposta
      EXIT_CODE=$(jq -r '.exitCode' risk-gate-response.json)
      DECISION=$(jq -r '.finalDecision' risk-gate-response.json)
      RISK=$(jq -r '.overallRiskLevel' risk-gate-response.json)
      SUMMARY=$(jq -r '.summary' risk-gate-response.json)
      
      echo "Decision: $DECISION"
      echo "Risk Level: $RISK"
      echo "Exit Code: $EXIT_CODE"
      echo ""
      echo "$SUMMARY"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # Staging geralmente Ã© mais permissivo
      if [[ "$EXIT_CODE" == "2" ]]; then
        echo "âš ï¸ Risco alto detectado em STAGING"
        echo "âš ï¸ Recomenda-se revisÃ£o antes de merge"
        # NÃ£o bloqueia em staging por padrÃ£o
      elif [[ "$EXIT_CODE" == "1" ]]; then
        echo "âš ï¸ Pipeline aprovado com restriÃ§Ãµes"
      else
        echo "âœ… Pipeline aprovado"
      fi

# Job opcional: Comentar no MR (requer permissÃµes)
# risk-gate:comment:
#   stage: risk-gate
#   needs:
#     - risk-gate:production
#   rules:
#     - if: '$CI_MERGE_REQUEST_IID && $GITLAB_API_TOKEN'
#   script:
#     - |
#       DECISION=$(jq -r '.finalDecision' risk-gate-response.json)
#       SUMMARY=$(jq -r '.summary' risk-gate-response.json)
#       
#       COMMENT="## ğŸ” Risk Gate Analysis\n\n**Decision:** $DECISION\n\n$SUMMARY"
#       
#       curl -X POST \
#         -H "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
#         -H "Content-Type: application/json" \
#         -d "{\"body\": \"$COMMENT\"}" \
#         "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
